<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Project Dashboard</title>
  <link rel="stylesheet" href="dashboard.css" />
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
</head>
<body>

  <main>
    <aside>
      <div class="filters">
        <h2>Filter Projects</h2>
        <div class="filter-group">
          <strong>Keywords</strong>
          <label><input type="checkbox" name="keywords" value="Citizen Science" /> Citizen Science </label>
          <label><input type="checkbox" name="keywords" value="Flood Management" /> Flood Management </label>
          <label><input type="checkbox" name="keywords" value="Nature Development" /> Nature Development </label>
          <label><input type="checkbox" name="keywords" value="Object-based Solutions" /> Object-based Solutions </label>
          <label><input type="checkbox" name="keywords" value="Purification" /> Purification </label>
          <label><input type="checkbox" name="keywords" value="Recreation" /> Recreation </label>
        </div>

        <div class="filter-group">
          <strong>Context</strong>
          <label><input type="checkbox" name="context" value="City" /> City</label>
          <label><input type="checkbox" name="context" value="Landscape" /> Landscape</label>
          <label><input type="checkbox" name="context" value="Peripheral" /> Peripheral</label>
        </div>

        <div class="filter-group">
          <strong>Country</strong>
          <label><input type="radio" name="country" value="Singapore" /> Singapore </label>
          <label><input type="radio" name="country" value="Netherlands" /> Netherlands </label>
          <label><input type="radio" name="country" value="United States" /> United States </label>
          <label><input type="radio" name="country" value="" checked /> All Countries </label>
        </div>
      </div>
    </aside>

    <div class="container" style="flex: 3">
      <div id="map" style="height: 90vh; width: 100%;"></div>
    </div>
  </main>

  <script>
    const apiUrl = 'https://594hcrq0.api.sanity.io/v2025-04-14/data/query/production?query=' +
      encodeURIComponent(`*[_type == "projects"]{
        projectName,
        description,
        "imageURL": image.asset->url,
        "imageAlt": projectName,
        location,
        keywordLabel,
        source,
        companyOrganization,
        context
      }`);

    let allProjects = [];
    let geocodedProjects = [];

    document.addEventListener('DOMContentLoaded', async () => {
      try {
        const response = await fetch(apiUrl);
        const { result: projects } = await response.json();
        allProjects = projects;

        geocodedProjects = await geocodeProjects(allProjects);
        renderMap(geocodedProjects);
        setupFilters();
      } catch (error) {
        console.error("Failed to load or geocode project data:", error);
        document.getElementById('map').innerHTML = "<p>Failed to load project map.</p>";
      }
    });

    async function geocodeProjects(projects) {
      const results = [];
      for (const project of projects) {
        const city = project.location;
        if (!city) continue;

        try {
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(city)}`);
          const data = await res.json();
          if (data[0]) {
            results.push({
              ...project,
              latitude: parseFloat(data[0].lat),
              longitude: parseFloat(data[0].lon)
            });
          }
        } catch (err) {
          console.warn(`Failed to geocode city: ${city}`, err);
        }

        await new Promise(res => setTimeout(res, 1000)); // 1 second delay for Nominatim
      }
      return results;
    }

    function setupFilters() {
      const inputs = document.querySelectorAll('input[name="keywords"], input[name="context"], input[name="country"]');
      inputs.forEach(input => input.addEventListener('change', applyFilters));
    }

    function applyFilters() {
      const keywords = Array.from(document.querySelectorAll('input[name="keywords"]:checked')).map(el => el.value);
      const contexts = Array.from(document.querySelectorAll('input[name="context"]:checked')).map(el => el.value);
      const country = document.querySelector('input[name="country"]:checked')?.value;

      const filtered = geocodedProjects.filter(p => {
        const matchKeyword = !keywords.length || keywords.includes(p.keywordLabel);
        const matchContext = !contexts.length || contexts.some(ctx => p.context?.includes(ctx));
        const matchCountry = !country || p.location === country;
        return matchKeyword && matchContext && matchCountry;
      });

      renderMap(filtered);
    }

    function renderMap(projects) {
      const data = [{
        type: 'scattergeo',
        mode: 'markers',
        lat: projects.map(p => p.latitude),
        lon: projects.map(p => p.longitude),
        text: projects.map(p => p.projectName),
        marker: {
          size: 8,
          color: '#3B609C',
          line: {
            color: '#fff',
            width: 1
          }
        }
      }];

      const layout = {
        geo: {
          showland: true,
          landcolor: '#f0f0f0',
          countrycolor: '#ccc',
          showcountries: true,
          projection: {
            type: 'natural earth'
          }
        },
        margin: { t: 0, b: 0, l: 0, r: 0 }
      };

      Plotly.newPlot('map', data, layout, { responsive: true });
    }
  </script>
</body>
</html>
